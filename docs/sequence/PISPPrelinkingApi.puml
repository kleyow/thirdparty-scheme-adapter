@startuml

title PISP Pre-linking

participant "PISP Backend" as PISP
box "PISP tp-scheme-adapter"
  participant "outbound-server" as PISP_TP_OUT
  participant "PISPPrelinkingModel" as PISP_PLM
  participant "inbound-server" as PISP_TP_IN
end box
box "Mojaloop"
    participant Switch
end box

== Pre-Linking ==
autonumber 1 "<b>LOOK-#</b>"
rnote right of PISP #LightBlue
GET /services/THIRD_PARTY_DFSP
NOTE: Should we just make this request the same as ML's API?
end note

PISP -> PISP_TP_OUT: GET /services/THIRD_PARTY_DFSP

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await create()
PISP_TP_OUT -> PISP_PLM: model.getThirdpartyEnabledDFSPs()

activate PISP_PLM

rnote right of PISP_PLM: state: requestTPEnabledDFSPs
PISP_PLM -> PISP_PLM: Check cache.\nDFSPs not stored in cache or cache is stale.
PISP_PLM -> PISP_PLM: ThirdpartyRequests.getServicesById()
PISP_PLM -> Switch: GET /services/THIRD_PARTY_DFSP

activate Switch
Switch --> PISP_PLM: 202 Accepted
deactivate PISP_PLM

note over PISP, Switch
  HAPPY_SCENARIO: Switch returns a non-empty list
end note

activate PISP_TP_IN

Switch --> PISP_TP_IN: PUT /services/THIRD_PARTY_DFSP
rnote left of Switch #LightBlue
PUT /services/THIRD_PARTY_DFSP
{
  serviceProviders: [
    "dfspa", "dfspb"
  ]
}
end note
PISP_TP_IN --> Switch: 200 OK

deactivate Switch

PISP_TP_IN -> PISP_PLM: Services request recieved

deactivate PISP_TP_IN
activate PISP_PLM

PISP_PLM -> PISP_PLM: Store DFSPs in cache
rnote right of PISP_PLM: state: TPEnabledDFSPsResolved
PISP_PLM -> PISP_TP_OUT: return TPEnabledDFSPs

deactivate PISP_PLM

PISP_TP_OUT --> PISP: 200 OK TPEnabledDFSPs

note over PISP, Switch
  ERROR_SCENARIO: Switch receives 7201 error.
  NOTE: What microservice is handling service lookup?
end note

activate PISP_TP_IN

Switch --> PISP_TP_IN: PUT /services/THIRD_PARTY_DFSP/error
rnote left of Switch #LightCoral
PUT /services/THIRD_PARTY_DFSP/error
{
  errorInformation: {
    errorCode: '7201',
    errorDescription: 'No thirdparty enabled FSP found'
  }
}
end note
PISP_TP_IN --> Switch: 200 OK

deactivate Switch

PISP_TP_IN -> PISP_PLM: ErrorInformationObject recieved

deactivate PISP_TP_IN
activate PISP_PLM

PISP_PLM -> PISP_PLM: throw same error
rnote right of PISP_PLM #LightCoral
{
  errorInformation: {
    errorCode: '7201',
    errorDescription: 'No thirdparty enabled FSP found'
  }
}
end note
rnote right of PISP_PLM: state: errored
PISP_PLM -> PISP_TP_OUT: catch MojaloopFSPIOPError

deactivate PISP_PLM

PISP_TP_OUT --> PISP: 500 Internal Server Error ErrorInformationObject


note over PISP, Switch
  ERROR_SCENARIO: Switch sends back any other error.
end note

activate PISP_TP_IN

Switch --> PISP_TP_IN: PUT /services/THIRD_PARTY_DFSP/error
rnote left of Switch #LightCoral
PUT /services/THIRD_PARTY_DFSP/error
{
  errorInformation: {
    errorCode: '2001',
    errorDescription: 'Internal server error'
  }
}
end note
PISP_TP_IN --> Switch: 200 OK

deactivate Switch

PISP_TP_IN -> PISP_PLM: Services request recieved

deactivate PISP_TP_IN
activate PISP_PLM

PISP_PLM -> PISP_PLM: throw account linking generic error
rnote right of PISP_PLM #LightCoral
{
  errorInformation: {
    errorCode: '7200',
    errorDescription: 'Generic Thirdparty account linking error'
  }
}
end note
rnote right of PISP_PLM: state: errored
PISP_PLM -> PISP_TP_OUT: catch MojaloopFSPIOPError

deactivate PISP_PLM

PISP_TP_OUT --> PISP: 500 Internal Server Error ErrorInformationObject

deactivate PISP_TP_OUT
deactivate PISP

== Pre-Linking - Cached ==
autonumber 1 "<b>LOOK-#</b>"
rnote right of PISP #LightBlue
GET /services/THIRD_PARTY_DFSP
NOTE: Should we just make this request the same as ML's API?
end note

PISP -> PISP_TP_OUT: GET /services/THIRD_PARTY_DFSP

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await create()
PISP_TP_OUT -> PISP_PLM: model.getThirdpartyEnabledDFSPs()

activate PISP_PLM

rnote right of PISP_PLM: state: requestTPEnabledDFSPs
PISP_PLM -> PISP_PLM: Check cache.\nDFSPs is stored in cache.
PISP_PLM -> PISP_PLM: Retrieve from cache
rnote right of PISP_PLM: state: TPEnabledDFSPsResolved
PISP_PLM -> PISP_TP_OUT: return TPEnabledDFSPs

deactivate PISP_PLM

PISP_TP_OUT --> PISP: 200 OK TPEnabledDFSPs

deactivate PISP_TP_OUT
deactivate PISP

...PISP presents DFSPs to User. User selects their DFSP. This is a natural break point in the account linking flow due to needing end-user input...

@enduml
